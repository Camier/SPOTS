<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spots Secrets Occitanie - Cartes IGN Officielles</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        /* Control panel */
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 300px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* IGN Layer selector */
        .layer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .layer-btn {
            padding: 10px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .layer-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .layer-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* Department checkboxes */
        .dept-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .dept-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .dept-item:hover {
            background: #f3f4f6;
        }
        
        .dept-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--dept-color);
        }
        
        .dept-label {
            flex: 1;
            font-size: 14px;
            color: #374151;
        }
        
        .dept-count {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }
        
        /* Department color coding */
        .dept-09 { --dept-color: #2563eb; }
        .dept-12 { --dept-color: #059669; }
        .dept-31 { --dept-color: #dc2626; }
        .dept-32 { --dept-color: #7c3aed; }
        .dept-46 { --dept-color: #ea580c; }
        .dept-65 { --dept-color: #0891b2; }
        .dept-81 { --dept-color: #84cc16; }
        .dept-82 { --dept-color: #f59e0b; }
        
        /* Elevation display */
        .elevation-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 14px;
            color: #374151;
            z-index: 1000;
        }
        
        /* Info box */
        .info-box {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            color: #1e40af;
            line-height: 1.5;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Custom controls */
        .custom-button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .custom-button:hover {
            background: #2563eb;
        }
        
        /* Legend */
        .legend {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div>Chargement des donn√©es IGN...</div>
    </div>
    
    <!-- Map container -->
    <div id="map"></div>
    
    <!-- Control panel -->
    <div class="control-panel">
        <div class="panel-title">
            <img src="https://www.ign.fr/sites/default/files/2021-06/logo_ign.svg" height="20" alt="IGN">
            Cartes IGN Officielles
        </div>
        
        <!-- IGN Layers -->
        <div class="panel-section">
            <div class="section-title">Fonds de carte IGN</div>
            <div class="layer-grid">
                <button class="layer-btn" onclick="switchLayer('plan')">Plan IGN</button>
                <button class="layer-btn active" onclick="switchLayer('satellite')">Satellite</button>
                <button class="layer-btn" onclick="switchLayer('topo')">Topographique</button>
                <button class="layer-btn" onclick="switchLayer('tourisme')">Touristique</button>
            </div>
        </div>
        
        <!-- Department filter -->
        <div class="panel-section">
            <div class="section-title">D√©partements</div>
            <div class="dept-list">
                <div class="dept-item dept-09">
                    <input type="checkbox" class="dept-checkbox" id="dept-09" checked onchange="filterDepartments()">
                    <label class="dept-label" for="dept-09">Ari√®ge</label>
                    <span class="dept-count" id="count-09">0</span>
                </div>
                <div class="dept-item dept-12">
                    <input type="checkbox" class="dept-checkbox" id="dept-12" checked onchange="filterDepartments()">
                    <label class="dept-label" for="dept-12">Aveyron</label>
                    <span class="dept-count" id="count-12">0</span>
                </div>
                <div class="dept-item dept-31">
                    <input type="checkbox" class="dept-checkbox" id="dept-31" checked onchange="filterDepartments()">
                    <label class="dept-label" for="dept-31">Haute-Garonne</label>
                    <span class="dept-count" id="count-31">0</span>
                </div>
                <div class="dept-item dept-32">
                    <input type="checkbox" class="dept-checkbox" id="dept-32" checked onchange="filterDepartments()">
                    <label class="dept-label" for="dept-32">Gers</label>
                    <span class="dept-count" id="count-32">0</span>
                </div>
                <div class="dept-item dept-46">
                    <input type="checkbox" class="dept-checkbox" id="dept-46" checked onchange="filterDepartments()">
                    <label class="dept-label" for="dept-46">Lot</label>
                    <span class="dept-count" id="count-46">0</span>
                </div>
                <div class="dept-item dept-65">
                    <input type="checkbox" class="dept-checkbox" id="dept-65" checked onchange="filterDepartments()">
                    <label class="dept-label" for="dept-65">Hautes-Pyr√©n√©es</label>
                    <span class="dept-count" id="count-65">0</span>
                </div>
                <div class="dept-item dept-81">
                    <input type="checkbox" class="dept-checkbox" id="dept-81" checked onchange="filterDepartments()">
                    <label class="dept-label" for="dept-81">Tarn</label>
                    <span class="dept-count" id="count-81">0</span>
                </div>
                <div class="dept-item dept-82">
                    <input type="checkbox" class="dept-checkbox" id="dept-82" checked onchange="filterDepartments()">
                    <label class="dept-label" for="dept-82">Tarn-et-Garonne</label>
                    <span class="dept-count" id="count-82">0</span>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="panel-section">
            <div class="section-title">Actions</div>
            <button class="custom-button" onclick="showDepartmentBoundaries()" style="width: 100%; margin-bottom: 8px;">
                Afficher limites d√©partements
            </button>
            <button class="custom-button" onclick="geocodeAddress()" style="width: 100%;">
                Rechercher une adresse
            </button>
        </div>
        
        <!-- Info -->
        <div class="info-box">
            <strong>Donn√©es IGN officielles</strong><br>
            Cartes et donn√©es g√©ographiques fournies par l'Institut national de l'information g√©ographique et foresti√®re
        </div>
    </div>
    
    <!-- Elevation display -->
    <div class="elevation-display" id="elevationDisplay" style="display: none;">
        Altitude: <span id="elevationValue">--</span> m
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script type="module">
        import IGNGeoservices from './js/modules/ign-geoservices.js';
        import REGIONAL_CONFIG, { getDepartmentFromCoords, getRegionalStats } from './js/modules/regional-config.js';
        
        // Initialize IGN services
        const ign = new IGNGeoservices();
        
        let map;
        let currentLayer;
        let spotsLayer;
        let departmentBoundariesLayer;
        let allSpots = [];
        let ignLayers = {};
        
        // Initialize map
        async function initMap() {
            map = L.map('map', {
                center: REGIONAL_CONFIG.center,
                zoom: REGIONAL_CONFIG.defaultZoom,
                maxZoom: 20
            });
            
            // Create IGN layers
            ignLayers = ign.createLeafletLayers();
            
            // Set default layer (satellite)
            currentLayer = ignLayers['IGN Satellite'];
            currentLayer.addTo(map);
            
            // Add click handler for elevation
            map.on('click', async (e) => {
                const elevation = await ign.getElevation(e.latlng.lat, e.latlng.lng);
                if (elevation) {
                    document.getElementById('elevationDisplay').style.display = 'block';
                    document.getElementById('elevationValue').textContent = Math.round(elevation);
                }
            });
            
            // Load spots
            await loadSpots();
            
            // Hide loading
            document.getElementById('loading').classList.add('hidden');
        }
        
        // Switch IGN layer
        window.switchLayer = function(type) {
            // Update button states
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Remove current layer
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            
            // Add new layer
            switch(type) {
                case 'plan':
                    currentLayer = ignLayers['IGN Plan'];
                    break;
                case 'satellite':
                    currentLayer = ignLayers['IGN Satellite'];
                    break;
                case 'topo':
                    currentLayer = ignLayers['IGN Cartes'];
                    break;
                case 'tourisme':
                    currentLayer = ignLayers['IGN Tourisme'];
                    break;
            }
            
            currentLayer.addTo(map);
        };
        
        // Load spots from API
        async function loadSpots() {
            try {
                const response = await fetch('http://localhost:8000/api/spots?limit=5000');
                const data = await response.json();
                allSpots = data.spots;
                
                // Update department counts
                updateDepartmentCounts();
                
                // Display spots
                displaySpots(allSpots);
                
            } catch (error) {
                console.error('Error loading spots:', error);
            }
        }
        
        // Update department counts
        function updateDepartmentCounts() {
            const stats = getRegionalStats(allSpots);
            
            Object.keys(stats).forEach(deptKey => {
                const deptInfo = REGIONAL_CONFIG.departments[deptKey];
                if (deptInfo) {
                    const countEl = document.getElementById(`count-${deptInfo.code}`);
                    if (countEl) {
                        countEl.textContent = stats[deptKey].count;
                    }
                }
            });
        }
        
        // Display spots on map
        function displaySpots(spots) {
            if (spotsLayer) {
                map.removeLayer(spotsLayer);
            }
            
            spotsLayer = L.markerClusterGroup({
                chunkedLoading: true,
                spiderfyOnMaxZoom: true,
                maxClusterRadius: 50
            });
            
            spots.forEach(spot => {
                const dept = getDepartmentFromCoords(spot.latitude, spot.longitude);
                const deptInfo = REGIONAL_CONFIG.departments[dept];
                
                if (deptInfo) {
                    const icon = L.divIcon({
                        html: `<div style="background: ${deptInfo.color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                        className: 'custom-marker',
                        iconSize: [18, 18],
                        iconAnchor: [9, 9]
                    });
                    
                    const marker = L.marker([spot.latitude, spot.longitude], { icon })
                        .bindPopup(async function() {
                            // Get address from IGN reverse geocoding
                            const location = await ign.reverseGeocode(spot.latitude, spot.longitude);
                            const address = location ? location.properties.label : 'Adresse inconnue';
                            
                            return `
                                <div style="min-width: 200px;">
                                    <h4 style="margin: 0 0 8px 0;">${spot.name || 'Spot Secret'}</h4>
                                    <div style="background: ${deptInfo.color}; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block; font-size: 12px; margin-bottom: 8px;">
                                        ${deptInfo.name}
                                    </div>
                                    <p style="margin: 4px 0; font-size: 13px;">${address}</p>
                                    <p style="margin: 4px 0; font-size: 12px; color: #666;">
                                        üìç ${spot.latitude.toFixed(5)}, ${spot.longitude.toFixed(5)}
                                    </p>
                                </div>
                            `;
                        });
                    
                    spotsLayer.addLayer(marker);
                }
            });
            
            map.addLayer(spotsLayer);
        }
        
        // Filter departments
        window.filterDepartments = function() {
            const selectedDepts = [];
            
            // Get selected departments
            document.querySelectorAll('.dept-checkbox:checked').forEach(checkbox => {
                selectedDepts.push(checkbox.id.replace('dept-', ''));
            });
            
            // Filter spots
            const filteredSpots = allSpots.filter(spot => {
                const dept = getDepartmentFromCoords(spot.latitude, spot.longitude);
                const deptCode = REGIONAL_CONFIG.departments[dept]?.code;
                return selectedDepts.includes(deptCode);
            });
            
            displaySpots(filteredSpots);
        };
        
        // Show department boundaries
        window.showDepartmentBoundaries = async function() {
            if (departmentBoundariesLayer) {
                map.removeLayer(departmentBoundariesLayer);
                departmentBoundariesLayer = null;
                event.target.textContent = 'Afficher limites d√©partements';
                return;
            }
            
            event.target.textContent = 'Masquer limites d√©partements';
            
            departmentBoundariesLayer = L.layerGroup();
            
            // Load boundaries for each department
            const departments = ['09', '12', '31', '32', '46', '65', '81', '82'];
            
            for (const deptCode of departments) {
                try {
                    // For now, draw approximate boundaries
                    // In production, would use actual IGN boundary data
                    const deptKey = Object.keys(REGIONAL_CONFIG.departments).find(
                        key => REGIONAL_CONFIG.departments[key].code === deptCode
                    );
                    
                    if (deptKey) {
                        const deptInfo = REGIONAL_CONFIG.departments[deptKey];
                        const bounds = getBoundsForDepartment(deptCode);
                        
                        if (bounds) {
                            const rect = L.rectangle(bounds, {
                                color: deptInfo.color,
                                weight: 3,
                                fillOpacity: 0.1,
                                dashArray: '10, 10'
                            }).bindTooltip(deptInfo.name, {
                                permanent: false,
                                direction: 'center'
                            });
                            
                            departmentBoundariesLayer.addLayer(rect);
                        }
                    }
                } catch (error) {
                    console.error(`Error loading boundaries for ${deptCode}:`, error);
                }
            }
            
            departmentBoundariesLayer.addTo(map);
        };
        
        // Get approximate bounds for department (temporary solution)
        function getBoundsForDepartment(deptCode) {
            const bounds = {
                '09': [[42.5, 0.8], [43.2, 2.2]],    // Ari√®ge
                '12': [[43.7, 1.8], [44.9, 3.1]],    // Aveyron
                '31': [[42.9, 0.4], [43.9, 2.0]],    // Haute-Garonne
                '32': [[43.3, -0.1], [44.1, 1.2]],   // Gers
                '46': [[44.2, 0.9], [45.1, 2.2]],    // Lot
                '65': [[42.7, -0.3], [43.5, 0.6]],   // Hautes-Pyr√©n√©es
                '81': [[43.4, 1.5], [44.2, 2.8]],    // Tarn
                '82': [[43.7, 0.7], [44.4, 1.8]]     // Tarn-et-Garonne
            };
            
            return bounds[deptCode];
        }
        
        // Geocode address
        window.geocodeAddress = async function() {
            const address = prompt('Entrez une adresse √† rechercher:');
            if (!address) return;
            
            const results = await ign.geocode(address);
            
            if (results && results.length > 0) {
                const result = results[0];
                const coords = result.geometry.coordinates;
                
                // Add marker
                L.marker([coords[1], coords[0]])
                    .addTo(map)
                    .bindPopup(`<b>${result.properties.label}</b>`)
                    .openPopup();
                
                // Center map
                map.setView([coords[1], coords[0]], 15);
            } else {
                alert('Adresse non trouv√©e');
            }
        };
        
        // Initialize
        initMap();
    </script>
</body>
</html>
