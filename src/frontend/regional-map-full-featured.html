<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spots Secrets Occitanie - Full Featured</title>
    
    <!-- Critical CSS inline -->
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 60px; bottom: 0; width: 100%; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; }
        .header { height: 60px; background: #2c3e50; color: white; display: flex; align-items: center; padding: 0 20px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Layer Control Styles */
        .layer-control {
            position: absolute;
            top: 70px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 250px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .layer-category {
            margin-bottom: 15px;
        }
        
        .layer-category h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
            text-transform: uppercase;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .layer-item:hover {
            background: #f0f0f0;
        }
        
        .layer-item input {
            margin-right: 8px;
        }
        
        .layer-item label {
            cursor: pointer;
            flex: 1;
            font-size: 13px;
        }
        
        /* GeoAI Tools Panel */
        .geoai-tools {
            position: absolute;
            bottom: 20px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .tool-btn {
            display: inline-block;
            width: 40px;
            height: 40px;
            margin: 2px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            text-align: center;
            line-height: 40px;
            transition: all 0.2s;
        }
        
        .tool-btn:hover {
            background: #3498db;
            color: white;
            transform: scale(1.1);
        }
        
        .tool-btn.active {
            background: #2980b9;
            color: white;
        }
        
        /* Filter Controls */
        #spot-filters {
            position: absolute;
            top: 70px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .filter-btn {
            display: block;
            width: 120px;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .filter-btn:hover {
            background: #f0f0f0;
        }
        
        .filter-btn.active {
            background: #3498db;
            color: white;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .layer-control {
                right: 5px;
                top: 65px;
                min-width: 200px;
                max-height: 400px;
            }
            
            #spot-filters {
                left: 5px;
                top: auto;
                bottom: 70px;
            }
            
            .geoai-tools {
                bottom: 10px;
            }
        }
    </style>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
</head>
<body>
    <div class="header">
        <h1 style="margin: 0; font-size: 1.5rem;">üó∫Ô∏è Spots Secrets Occitanie - Edition Compl√®te</h1>
        <div style="margin-left: auto;">
            <span id="spot-count">Chargement...</span>
        </div>
    </div>
    
    <div id="map">
        <div id="loading">
            <div class="spinner"></div>
            <p style="text-align: center; margin-top: 10px;">Chargement de la carte...</p>
        </div>
    </div>
    
    <!-- Layer Control -->
    <div class="layer-control" id="layer-control">
        <h3 style="margin: 0 0 15px 0; font-size: 16px;">üé® Couches Cartographiques</h3>
        <div id="layer-categories"></div>
    </div>
    
    <!-- Spot Filters -->
    <div id="spot-filters">
        <button class="filter-btn active" data-type="all">Tous üìç</button>
        <button class="filter-btn" data-type="cascade">Cascades üíß</button>
        <button class="filter-btn" data-type="grotte">Grottes üï≥Ô∏è</button>
        <button class="filter-btn" data-type="source">Sources üí¶</button>
        <button class="filter-btn" data-type="ruine">Ruines üèöÔ∏è</button>
    </div>
    
    <!-- GeoAI Tools -->
    <div class="geoai-tools">
        <div class="tool-btn" title="Mesurer" data-tool="measure">üìè</div>
        <div class="tool-btn" title="Profil d'altitude" data-tool="elevation">üìä</div>
        <div class="tool-btn" title="Dessiner" data-tool="draw">‚úèÔ∏è</div>
        <div class="tool-btn" title="Itin√©raire" data-tool="routing">üö∂</div>
        <div class="tool-btn" title="Vue 3D" data-tool="3d">üèîÔ∏è</div>
        <div class="tool-btn" title="Analyse spatiale" data-tool="spatial">üîç</div>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script type="module">
        // Performance timing
        const startTime = performance.now();
        
        // Initialize map
        const map = L.map('map', {
            center: [43.6, 1.9],
            zoom: 8,
            preferCanvas: true
        });
        
        // IGN Layer definitions
        const ignLayers = {
            // Cartes de base
            plan_ign: {
                name: 'Plan IGN',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png', {
                    attribution: '¬© IGN',
                    maxZoom: 18
                }),
                category: 'Cartes de base',
                default: true
            },
            satellite: {
                name: 'Satellite',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/jpeg', {
                    attribution: '¬© IGN',
                    maxZoom: 19
                }),
                category: 'Cartes de base'
            },
            scan25: {
                name: 'Carte TOP 25',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN25TOUR&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/jpeg', {
                    attribution: '¬© IGN',
                    maxZoom: 16
                }),
                category: 'Cartes de base'
            },
            
            // Cartes th√©matiques
            forest: {
                name: 'For√™ts',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=LANDCOVER.FORESTINVENTORY.V2&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png', {
                    attribution: '¬© IGN',
                    opacity: 0.7,
                    maxZoom: 16
                }),
                category: 'Th√©matiques'
            },
            geology: {
                name: 'G√©ologie',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOLOGIE.GEOL&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png', {
                    attribution: '¬© BRGM',
                    opacity: 0.6,
                    maxZoom: 14
                }),
                category: 'Th√©matiques'
            },
            hydrography: {
                name: 'Hydrographie',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=HYDROGRAPHIE&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png', {
                    attribution: '¬© IGN',
                    opacity: 0.8,
                    maxZoom: 18
                }),
                category: 'Th√©matiques'
            },
            
            // Cartes historiques
            cassini: {
                name: 'Carte de Cassini (XVIIIe)',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.CASSINI&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/jpeg', {
                    attribution: '¬© IGN',
                    maxZoom: 15
                }),
                category: 'Historiques'
            },
            etat_major: {
                name: '√âtat-Major (XIXe)',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.ETATMAJOR40&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/jpeg', {
                    attribution: '¬© IGN',
                    maxZoom: 15
                }),
                category: 'Historiques'
            },
            
            // Donn√©es cadastrales
            cadastre: {
                name: 'Parcelles cadastrales',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=CADASTRALPARCELS.PARCELLAIRE_EXPRESS&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png', {
                    attribution: '¬© DGFiP',
                    opacity: 0.6,
                    minZoom: 14,
                    maxZoom: 20
                }),
                category: 'Administratif'
            },
            
            // Relief
            elevation: {
                name: 'Courbes de niveau',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=ELEVATION.CONTOUR.LINE&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png', {
                    attribution: '¬© IGN',
                    opacity: 0.5,
                    maxZoom: 17
                }),
                category: 'Relief'
            },
            slope: {
                name: 'Pentes',
                layer: L.tileLayer('https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=ELEVATION.SLOPES&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png', {
                    attribution: '¬© IGN',
                    opacity: 0.6,
                    maxZoom: 15
                }),
                category: 'Relief'
            }
        };
        
        // Active layers tracking
        const activeLayers = new Set(['plan_ign']);
        
        // Add default layer
        ignLayers.plan_ign.layer.addTo(map);
        
        // Hide loading once tiles start loading
        ignLayers.plan_ign.layer.once('loading', () => {
            document.getElementById('loading').style.display = 'none';
        });
        
        // Create layer control UI
        function createLayerControl() {
            const container = document.getElementById('layer-categories');
            const categories = {};
            
            // Group layers by category
            for (const [key, config] of Object.entries(ignLayers)) {
                if (!categories[config.category]) {
                    categories[config.category] = [];
                }
                categories[config.category].push({ key, ...config });
            }
            
            // Create UI for each category
            for (const [category, layers] of Object.entries(categories)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'layer-category';
                
                const categoryTitle = document.createElement('h4');
                categoryTitle.textContent = category;
                categoryDiv.appendChild(categoryTitle);
                
                layers.forEach(({ key, name }) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'layer-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `layer-${key}`;
                    checkbox.checked = activeLayers.has(key);
                    
                    const label = document.createElement('label');
                    label.htmlFor = `layer-${key}`;
                    label.textContent = name;
                    
                    checkbox.addEventListener('change', () => toggleLayer(key, checkbox.checked));
                    
                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    categoryDiv.appendChild(itemDiv);
                });
                
                container.appendChild(categoryDiv);
            }
        }
        
        // Toggle layer visibility
        function toggleLayer(layerKey, show) {
            const layerConfig = ignLayers[layerKey];
            if (show) {
                layerConfig.layer.addTo(map);
                activeLayers.add(layerKey);
            } else {
                map.removeLayer(layerConfig.layer);
                activeLayers.delete(layerKey);
            }
        }
        
        // Initialize layer control
        createLayerControl();
        
        // Load spots data
        async function loadSpots() {
            try {
                const response = await fetch('http://localhost:8000/api/spots/quality?limit=1000');
                const data = await response.json();
                return data.spots || [];
            } catch (error) {
                console.error('API failed, trying fallback:', error);
                const response = await fetch('/data/main/spots_map_data.json');
                return await response.json();
            }
        }
        
        // Spot icons
        const spotIcons = {
            cascade: 'üíß',
            grotte: 'üï≥Ô∏è',
            source: 'üí¶',
            ruine: 'üèöÔ∏è',
            default: 'üìç'
        };
        
        // Create marker cluster group
        const markers = L.markerClusterGroup({
            chunkedLoading: true,
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: false,
            showCoverageOnHover: false
        });
        
        // Load and display spots
        loadSpots().then(spots => {
            document.getElementById('spot-count').textContent = `${spots.length} spots secrets`;
            
            // Add all markers
            spots.forEach(spot => {
                const icon = L.divIcon({
                    html: `<div style="font-size: 24px;">${spotIcons[spot.type] || spotIcons.default}</div>`,
                    iconSize: [24, 24],
                    className: 'custom-div-icon'
                });
                
                const marker = L.marker([spot.latitude, spot.longitude], { icon });
                
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0;">${spot.name}</h3>
                        <p><strong>Type:</strong> ${spot.type}</p>
                        <p><strong>Description:</strong> ${spot.description || 'Pas de description'}</p>
                        ${spot.beauty_rating ? `<p><strong>Beaut√©:</strong> ${'‚≠ê'.repeat(spot.beauty_rating)}</p>` : ''}
                        ${spot.difficulty ? `<p><strong>Difficult√©:</strong> ${spot.difficulty}/5</p>` : ''}
                    </div>
                `, { maxWidth: 300 });
                
                marker.spotData = spot;
                markers.addLayer(marker);
            });
            
            map.addLayer(markers);
            
            // Setup filters
            setupFilters(spots, markers);
            
            // Performance log
            const loadTime = performance.now() - startTime;
            console.log(`Map loaded in ${loadTime.toFixed(0)}ms with ${spots.length} spots`);
        });
        
        // Filter functionality
        function setupFilters(spots, markerGroup) {
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active state
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const type = btn.dataset.type;
                    
                    // Clear and re-add filtered markers
                    markerGroup.clearLayers();
                    
                    const filteredSpots = type === 'all' 
                        ? spots 
                        : spots.filter(spot => spot.type === type);
                    
                    filteredSpots.forEach(spot => {
                        const icon = L.divIcon({
                            html: `<div style="font-size: 24px;">${spotIcons[spot.type] || spotIcons.default}</div>`,
                            iconSize: [24, 24],
                            className: 'custom-div-icon'
                        });
                        
                        const marker = L.marker([spot.latitude, spot.longitude], { icon });
                        
                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                <h3 style="margin: 0 0 10px 0;">${spot.name}</h3>
                                <p><strong>Type:</strong> ${spot.type}</p>
                                <p><strong>Description:</strong> ${spot.description || 'Pas de description'}</p>
                                ${spot.beauty_rating ? `<p><strong>Beaut√©:</strong> ${'‚≠ê'.repeat(spot.beauty_rating)}</p>` : ''}
                                ${spot.difficulty ? `<p><strong>Difficult√©:</strong> ${spot.difficulty}/5</p>` : ''}
                            </div>
                        `, { maxWidth: 300 });
                        
                        marker.spotData = spot;
                        markerGroup.addLayer(marker);
                    });
                    
                    // Update count
                    document.getElementById('spot-count').textContent = `${filteredSpots.length} spots secrets`;
                });
            });
        }
        
        // GeoAI Tools functionality
        const tools = {
            measure: null,
            draw: null,
            elevation: null,
            routing: null
        };
        
        // Tool button click handlers
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tool = btn.dataset.tool;
                
                // Toggle active state
                if (btn.classList.contains('active')) {
                    btn.classList.remove('active');
                    disableTool(tool);
                } else {
                    // Deactivate other tools
                    document.querySelectorAll('.tool-btn.active').forEach(b => {
                        b.classList.remove('active');
                        disableTool(b.dataset.tool);
                    });
                    
                    btn.classList.add('active');
                    enableTool(tool);
                }
            });
        });
        
        function enableTool(toolName) {
            switch(toolName) {
                case 'measure':
                    // Simple distance measurement
                    L.control.scale({ imperial: false }).addTo(map);
                    alert('Cliquez sur la carte pour mesurer des distances');
                    break;
                    
                case 'draw':
                    // Enable drawing
                    if (!tools.draw) {
                        tools.draw = new L.Control.Draw({
                            draw: {
                                polygon: true,
                                polyline: true,
                                rectangle: true,
                                circle: true,
                                marker: true
                            }
                        });
                        map.addControl(tools.draw);
                    }
                    break;
                    
                case 'elevation':
                    alert('Profil d\'altitude: Cliquez sur deux points pour voir le d√©nivel√©');
                    break;
                    
                case 'routing':
                    alert('Itin√©raire: Cliquez sur le point de d√©part puis d\'arriv√©e');
                    break;
                    
                case '3d':
                    alert('Vue 3D: Fonctionnalit√© en cours de d√©veloppement');
                    break;
                    
                case 'spatial':
                    alert('Analyse spatiale: S√©lectionnez une zone pour analyser les spots');
                    break;
            }
        }
        
        function disableTool(toolName) {
            switch(toolName) {
                case 'draw':
                    if (tools.draw) {
                        map.removeControl(tools.draw);
                    }
                    break;
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'l':
                        e.preventDefault();
                        document.getElementById('layer-control').style.display = 
                            document.getElementById('layer-control').style.display === 'none' ? 'block' : 'none';
                        break;
                    case 'm':
                        e.preventDefault();
                        document.querySelector('[data-tool="measure"]').click();
                        break;
                    case 'd':
                        e.preventDefault();
                        document.querySelector('[data-tool="draw"]').click();
                        break;
                }
            }
        });
    </script>
</body>
</html>