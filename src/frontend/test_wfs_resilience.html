<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WFS Resilience - SPOTS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #FF9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        #map {
            height: 500px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-item {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
        }
        .status-online { border-left-color: #4CAF50; }
        .status-offline { border-left-color: #f44336; }
        .status-fallback { border-left-color: #FF9800; }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            margin: 2px 0;
            padding: 4px;
            background: #f0f0f0;
        }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-warning { color: #FF9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de R√©silience WFS - SPOTS Platform</h1>
        
        <div class="test-controls">
            <h2>Contr√¥les de Test</h2>
            <button class="test-button btn-primary" onclick="testNormalOperation()">
                ‚úÖ Test Op√©ration Normale
            </button>
            <button class="test-button btn-warning" onclick="testWithTimeout()">
                ‚è±Ô∏è Test avec Timeout
            </button>
            <button class="test-button btn-danger" onclick="testOfflineMode()">
                üìµ Simuler Mode Hors Ligne
            </button>
            <button class="test-button btn-success" onclick="testRecovery()">
                üîÑ Test R√©cup√©ration
            </button>
            <button class="test-button btn-primary" onclick="testSpotAnalysis()">
                üéØ Analyser Spot #1
            </button>
        </div>

        <div id="map"></div>

        <div class="status-panel">
            <h2>√âtat du Service</h2>
            <div id="service-status"></div>
            
            <h3>Journal des Tests</h3>
            <div id="test-log" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <script src="src/frontend/js/ign-wfs-client.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([43.6, 1.44], 10); // Toulouse area
        
        // Add base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Initialize WFS client
        let wfsClient = new IGNWFSClient('http://localhost:8000/api/ign');
        wfsClient.startMonitoring();
        
        // Update status display
        function updateStatus() {
            const status = wfsClient.getServiceStatus();
            const statusDiv = document.getElementById('service-status');
            
            statusDiv.innerHTML = `
                <div class="status-item ${status.isOnline ? 'status-online' : 'status-offline'}">
                    <strong>√âtat:</strong> ${status.isOnline ? 'üü¢ En ligne' : 'üî¥ Hors ligne'}
                </div>
                <div class="status-item">
                    <strong>Cache:</strong> ${status.cacheSize} entr√©es
                </div>
                <div class="status-item">
                    <strong>Timeout:</strong> ${status.requestTimeout}ms
                </div>
                ${status.lastError ? `
                    <div class="status-item status-offline">
                        <strong>Derni√®re erreur:</strong> ${status.lastError.message}
                    </div>
                ` : ''}
            `;
        }

        // Log function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Test functions
        async function testNormalOperation() {
            log('üß™ Test op√©ration normale...', 'info');
            
            try {
                // Test capabilities
                const capabilities = await wfsClient.getCapabilities();
                log(`‚úÖ Capabilities: ${capabilities.status}`, 'success');
                
                // Test transport query
                const transport = await wfsClient.queryTransportNetwork(43.6, 1.44, 1000);
                log(`‚úÖ Transport: ${transport.status || transport.result.status}`, 'success');
                
                // Test hydrography
                const hydro = await wfsClient.queryHydrography(43.6, 1.44, 2000);
                log(`‚úÖ Hydrographie: ${hydro.status || hydro.result.status}`, 'success');
                
                updateStatus();
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function testWithTimeout() {
            log('üß™ Test avec timeout court...', 'info');
            
            // Temporarily reduce timeout
            const originalTimeout = wfsClient.requestTimeout;
            wfsClient.requestTimeout = 100; // 100ms - tr√®s court
            
            try {
                const result = await wfsClient.queryTransportNetwork(43.6, 1.44, 1000);
                if (result.status === 'fallback') {
                    log('‚ö†Ô∏è Fallback activ√© apr√®s timeout', 'warning');
                } else {
                    log('‚úÖ Requ√™te r√©ussie malgr√© timeout court', 'success');
                }
            } catch (error) {
                log(`‚ö†Ô∏è Timeout g√©r√©: ${error.message}`, 'warning');
            }
            
            // Restore timeout
            wfsClient.requestTimeout = originalTimeout;
            updateStatus();
        }

        async function testOfflineMode() {
            log('üß™ Simulation mode hors ligne...', 'info');
            
            // Force offline mode
            wfsClient.isOnline = false;
            
            try {
                const capabilities = await wfsClient.getCapabilities();
                if (capabilities.status === 'fallback') {
                    log('‚úÖ Mode fallback activ√© correctement', 'success');
                    log(`üìä Message: ${capabilities.message}`, 'info');
                }
                
                const analysis = await wfsClient.getSpotWFSAnalysis(1);
                if (analysis.wfs_analysis && analysis.wfs_analysis.status === 'fallback') {
                    log('‚úÖ Analyse fallback fonctionnelle', 'success');
                    log(`üìä Score estim√©: ${analysis.wfs_analysis.accessibility_score.overall}/100`, 'info');
                }
            } catch (error) {
                log(`‚ùå Erreur non g√©r√©e: ${error.message}`, 'error');
            }
            
            updateStatus();
        }

        async function testRecovery() {
            log('üß™ Test de r√©cup√©ration...', 'info');
            
            // Re-test connectivity
            await wfsClient._testConnectivity();
            
            setTimeout(() => {
                updateStatus();
                if (wfsClient.isOnline) {
                    log('‚úÖ Service r√©cup√©r√© avec succ√®s', 'success');
                } else {
                    log('‚ö†Ô∏è Service toujours hors ligne', 'warning');
                }
            }, 1000);
        }

        async function testSpotAnalysis() {
            log('üß™ Analyse du spot #1...', 'info');
            
            try {
                // Add a test marker
                const marker = L.marker([43.6, 1.44]).addTo(map);
                marker.bindPopup('Spot Test #1').openPopup();
                
                // Visualize environment
                const analysis = await wfsClient.visualizeSpotEnvironment(map, 1, [43.6, 1.44]);
                
                if (analysis.wfs_analysis) {
                    const status = analysis.wfs_analysis.status || analysis.status;
                    log(`üìä Analyse ${status}: Score ${analysis.wfs_analysis.accessibility_score?.overall || analysis.accessibility_score?.overall}/100`, 
                        status === 'fallback' ? 'warning' : 'success');
                }
                
                updateStatus();
            } catch (error) {
                log(`‚ùå Erreur analyse: ${error.message}`, 'error');
            }
        }

        // Initial status update
        updateStatus();
        
        // Auto-update status every 5 seconds
        setInterval(updateStatus, 5000);
        
        // Listen for WFS refresh events
        document.addEventListener('wfs-refresh', (event) => {
            log(`üîÑ Refresh demand√© pour spot ${event.detail.spotId}`, 'info');
            testSpotAnalysis();
        });
        
        log('‚úÖ Test de r√©silience WFS initialis√©', 'success');
    </script>
</body>
</html>